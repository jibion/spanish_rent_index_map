<html>

<head>
  <meta charset="utf-8">
  <script src="./js/anychart-base.min.js"></script>
  <script src="./js/anychart-ui.min.js"></script>
  <script src="./js/anychart-exports.min.js"></script>
  <script src="./js/anychart-circular-gauge.min.js"></script>
  <script src="./js/anychart-map.min.js"></script>
  <script src="./js/anychart-table.min.js"></script>
  <script src="./js/anychart-data-adapter.min.js"></script>
  <script src="./geodata/countries/spain/spain.js"></script>
  <script src="./js/proj4.js"></script>
  <link href="./css/style.css" type="text/css"
    rel="stylesheet">
  <link href="./css/anychart-ui.min.css" type="text/css" rel="stylesheet">
  <link href="./fonts/css/anychart-font.min.css" type="text/css" rel="stylesheet">
  <style type="text/css">
    html,
    body,
    #container {
      width: 100%;
      height: 100%;
      margin: 0 auto;
      padding: 0;
    }
  </style>
</head>

<body>

  <div id="container"></div>


  <script>

    anychart.onDocumentReady(function () {
      anychart.data.loadJsonFile(
        './data/data_provincias_vc.json',
        function (data) {
          var regionsData = data;
          var selectedPoint;
          var mapChart;
          var totalRentChart;

          var drawMapChart = function () {
            var map = anychart.map();
            map.geoData('anychart.maps.spain');
            map.title().enabled(true).useHtml(true).text(
              '<span style="color: #212121;">Precio promedio del metro cuadrado por provincias'
            ).fontSize(18).padding([15, 0, 15, 0]);

            var cr = map.colorRange();
            cr.enabled(true).colorLineSize(10).padding([0, 0, 15, 0]);
            cr.marker().size(7);
            cr.orientation('bottom');
            cr.length(600);
            cr.ticks()
              .enabled(true)
              .position('center')
              .length(10)
              .stroke('2 #fff');
            cr.labels().format(function () {
              var range = this.colorRange;
              var name;
              if (isFinite(range.start + range.end)) {
                name =
                  range.start.toLocaleString() +
                  ' € - ' +
                  range.end.toLocaleString() + ' €';
              } else if (isFinite(range.start)) {
                name = '> ' + range.start.toLocaleString() + ' €';
              } else {
                name = '< ' + range.end.toLocaleString() + ' €';
              }
              return name;
            });
            cr.listen('mousedown', function (e) {
              e.preventDefault();
              e.stopPropagation();
            });

            var s1 = map.choropleth();
            s1.geoIdField('id');
            s1.labels(null);
            var ocs = anychart.scales.ordinalColor([
              { less: 4 },
              { from: 4, to: 4.5 },
              { from: 4.5, to: 5 },
              { from: 5, to: 6 },
              { from: 6, to: 7.5 },
              { greater: 7.5 }
            ]);
            ocs.colors([
              '#ffd54f',
              '#FDC543',
              '#F9B033',
              '#F7A028',
              '#F28110',
              '#ef6c00'
            ]);
            s1.colorScale(ocs);
            s1.hovered().fill('#1976d2 0.6');
            s1.selected().fill('#1976d2');
            s1.tooltip().title().fontSize(16);
            s1.tooltip().title().useHtml(true);
            s1.tooltip().titleFormat(function () {
              return this.getData('x');
            });
            s1.tooltip()
              .useHtml(true)
              .format(function () {
                return (
                  '<span style="color:#d9d9d9">Precio promedio m<sup>2</sup>: ' +
                  this.value.toLocaleString() + ' €</span>'
                );
              });
            s1.labels().enabled(true).padding(1).format(function () {
              return this.getData('abr');
            })
            map.padding(0, 30, 5, 0).margin(0);
            map.getSeries(0).data(regionsData);
            map.listen('pointsselect', function (e) {
              selectedPoint = e.currentPoint;
              if (selectedPoint) {
                changeContents(selectedPoint.index);
              }
            });
            return map;
          };

          var drawtotalRentChart = function () {
            // create column chart
            var chart = anychart.column();

            // turn on chart animation
            chart.animation(true);

            // set chart title text settings
            chart.title().align("center").enabled(true).text("Precio del alquiler mensual");

            // temp variable to store series instance
            var series;

            // helper function to setup label settings for all series
            var setupSeries = function (series, name) {
              series.name(name);
              series.selected().fill('#f48fb1 0.8').stroke('1.5 #c2185b');
            };

            // create first series with mapped data
            series = chart.column(firstMapping);
            series.name('Media');
            series.tooltip().title().fontSize(16);
            series.tooltip().titleFormat(function () {
              return this.x;
            });
            series
              .tooltip()
              .useHtml(true)
              .format(function () {
                return (
                  '<span style="color:#d9d9d9">Media:</span> ' +
                  this.value.toLocaleString() + ' €'
                );
              });

            var series2 = chart.line(secondMapping);
            series2.name('Rango inferior');
            series2.tooltip().title().fontSize(16);
            series2.tooltip().titleFormat(function () {
              return this.x;
            });
            series2
              .tooltip()
              .useHtml(true)
              .format(function () {
                return (
                  '<span style="color:#d9d9d9">Rango inferior:</span> ' +
                  this.value.toLocaleString() + ' €'
                );
              });

            var series3 = chart.line(thirdMapping);
            series3.name('Rango superior');
            series3.tooltip().title().fontSize(16);
            series3.tooltip().titleFormat(function () {
              return this.x;
            });
            series3
              .tooltip()
              .useHtml(true)
              .format(function () {
                return (
                  '<span style="color:#d9d9d9">Rango superior:</span> ' +
                  this.value.toLocaleString() + ' €'
                );
              });

            // set chart padding
            chart.barGroupsPadding(0.3);

            // format numbers in y axis label to match browser locale
            chart.yAxis().labels().format('{%Value}{groupsSeparator: } €');

            // set titles for Y-axis
            chart.yAxis().title('Alquiler mensual (€)');

            // turn on legend
            chart.legend().enabled(true).fontSize(13).padding([0, 0, 20, 0]);

            chart.interactivity().hoverMode('single');

            chart.tooltip().format('{%Value}{groupsSeparator: } €');

            // set container id for the chart
            chart.container('container');

            // initiate chart drawing
            return chart;
          };

          var drawm2RentChart = function () {
            var lineChart = anychart.line(
              m2RentDataSet.mapAs({ value: 1, x: 0 })
            );
            var title = lineChart.title();
            lineChart.animation(true);
            //enables HTML tags
            lineChart.tooltip().format('{%value} €');
            lineChart.yAxis().title('Coste m2 (€)');
            lineChart.yAxis().labels().format('{%Value}{groupsSeparator: } €');
            return lineChart;
          };


          var totalRentDataSet = anychart.data.set();
          var m2RentDataSet = anychart.data.set();

          var firstSeries = m2RentDataSet.mapAs({
            value: 1,
            x: 0
          });
          var firstMapping = totalRentDataSet.mapAs({
            value: 1,
            x: 0
          });
          var secondMapping = totalRentDataSet.mapAs({
            value: 2,
            x: 0
          });
          var thirdMapping = totalRentDataSet.mapAs({
            value: 3,
            x: 0
          });

          var changeContents = function (index) {
            totalRentDataSet.data(regionsData[index].total_rent);
            m2RentDataSet.data(regionsData[index].m2_rent);
            m2RentChart.title().align("center").enabled(true).useHtml(true).text(
              "<strong>" + regionsData[index].x + "</strong><br />Precio del alquiler por metro cuadrado");
          };
          mapChart = drawMapChart();
          totalRentChart = drawtotalRentChart();
          m2RentChart = drawm2RentChart();

          function fillInMainTable(flag) {
            if (flag === 'wide') {
              layoutTable.contents(
                [
                  [mapChart, m2RentChart],
                  [null, totalRentChart]
                ],
                true
              );
              layoutTable.getCell(0, 0).rowSpan(2);
              layoutTable.getCol(0).width('65%');
              layoutTable.getRow(0).height('60%');
            } else {
              layoutTable.contents(
                [
                  [mapChart],
                  [m2RentChart],
                  [totalRentChart]
                ],
                true
              );
              layoutTable.getRow(0).height(500);
              layoutTable.getRow(1).height(300);
              layoutTable.getRow(2).height(300);
            }
            layoutTable.draw();
          }

          // Setting layout table
          var layoutTable = anychart.standalones.table();
          layoutTable.cellBorder(null);
          layoutTable.container('container');

          if (window.innerWidth > 768) fillInMainTable('wide');
          else {
            fillInMainTable('slim');
          }

          mapChart.getSeries(0).select(44);
          changeContents(44);
          // On resize changing layout to mobile version or conversely
          window.onresize = function () {
            if (layoutTable.colsCount() === 2 && window.innerWidth > 767) {
              fillInMainTable('wide');
            } else if (
              layoutTable.colsCount() === 3 &&
              window.innerWidth <= 767
            ) {
              fillInMainTable('slim');
            }
          };
        }
      );
    });

  </script>
</body>

</html>